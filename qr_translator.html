
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BYOB – QR Translator</title>

<!-- Libraries -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body {
  font-family: sans-serif;
  max-width: 600px;
  margin: auto;
  padding: 20px;
}

h2, h3 {
  text-align: center;
}

textarea {
  width: 100%;
  font-size: 14px;
  margin: 5px 0;
}

button {
  padding: 10px;
  margin: 5px 0;
  width: 100%;
  font-size: 16px;
}

hr {
  margin: 40px 0;
}

/* Canvas wrapper for perfect square display */
.canvas-wrapper {
  width: 80%;
  max-width: 300px;      /* Display size cap */
  aspect-ratio: 1 / 1;   /* Force square */
  margin: 20px auto;
  border: 1px solid #ccc;
}

.canvas-wrapper canvas {
  width: 100%;
  height: 100%;
  display: block;
}
</style>
</head>
<body>

<h2>BYOB – QR Translator</h2>

<!-- ================= ENCODE SECTION ================= -->
<h3>Scan Plaintext QR</h3>
<div id="qr-reader-seed" style="width:100%;"></div>
<button onclick="startSeedScanner()">Start Camera Scanner</button>

<textarea id="seedInput" placeholder="Enter 12 seed words here" rows="3"></textarea>

<button onclick="generateCoordinateQR()">Generate Coordinate QR</button>
<div class="canvas-wrapper">
  <canvas id="coordinateQRCanvas"></canvas>
</div>

<hr>

<!-- ================= DECODE SECTION ================= -->
<h3>Scan Coordinate QR</h3>
<div id="qr-reader-coord" style="width:100%;"></div>
<button onclick="startCoordinateScanner()">Start Camera Scanner</button>

<textarea id="coordinateInput" placeholder="72 digit coordinate string will appear here" rows="3"></textarea>

<button onclick="decodeCoordinates()">Decode</button>

<textarea id="decodedSeedOutput" placeholder="Decoded 12 seed words will appear here" rows="3"></textarea>

<button onclick="generateSeedQRFromDecoded()">Generate Seed QR</button>
<div class="canvas-wrapper">
  <canvas id="decodedSeedQRCanvas"></canvas>
</div>

<script>
let canonicalWall = {};
let seedScanner;
let coordinateScanner;

// -------- LOAD CANONICAL WALL --------
fetch('BOSA_canonical_wall.json')
  .then(resp => resp.json())
  .then(data => {
      canonicalWall = data.mapping;
      console.log("Loaded canonical wall:", data.meta.community);
  })
  .catch(err => {
      alert("Error loading canonical wall JSON.");
  });

// -------- HIGH RES QR FUNCTION --------
function generateHighResQR(canvasId, text, filename){
    const canvas = document.getElementById(canvasId);
    const size = 1200; // print resolution
    canvas.width = size;
    canvas.height = size;

    QRCode.toCanvas(canvas, text, {
        width: size,
        margin: 4,
        errorCorrectionLevel: 'H'
    }, function(error){
        if(error){
            console.error(error);
            alert("QR generation error.");
            return;
        }
        downloadCanvas(canvas, filename);
    });
}

// -------- DOWNLOAD FUNCTION --------
function downloadCanvas(canvas, filename){
    const link = document.createElement("a");
    link.download = filename;
    link.href = canvas.toDataURL("image/png");
    link.click();
}

// -------- SEED SCANNER --------
function startSeedScanner(){
    seedScanner = new Html5Qrcode("qr-reader-seed");
    seedScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        message => {
            document.getElementById("seedInput").value = message.trim();
            seedScanner.stop();
        }
    );
}

// -------- COORDINATE SCANNER --------
function startCoordinateScanner(){
    coordinateScanner = new Html5Qrcode("qr-reader-coord");
    coordinateScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        message => {
            document.getElementById("coordinateInput").value = message.trim();
            coordinateScanner.stop();
        }
    );
}

// -------- GENERATE COORDINATE QR --------
function generateCoordinateQR(){
    const seedWords = document.getElementById("seedInput")
                      .value.trim().toLowerCase().split(/\s+/);

    if(seedWords.length !== 12){
        alert("Enter exactly 12 seed words.");
        return;
    }

    let coordinateString = "";

    for(let word of seedWords){
        if(!canonicalWall[word]){
            alert("Word not found in canonical wall: " + word);
            return;
        }
        coordinateString += canonicalWall[word];
    }

    generateHighResQR(
        "coordinateQRCanvas",
        coordinateString,
        "coordinate_seed_print.png"
    );
}

// -------- DECODE COORDINATES --------
function decodeCoordinates(){
    const input = document.getElementById("coordinateInput").value.trim();

    if(!/^\d{72}$/.test(input)){
        alert("Coordinate string must be exactly 72 digits.");
        return;
    }

    const words = [];
    for(let i=0; i<72; i+=6){
        const coord = input.slice(i,i+6);
        const word = Object.keys(canonicalWall).find(key => canonicalWall[key] === coord);
        if(!word){
            alert("Invalid coordinate: " + coord);
            return;
        }
        words.push(word);
    }

    document.getElementById("decodedSeedOutput").value = words.join(" ");
}

// -------- GENERATE STANDARD SEED QR --------
function generateSeedQRFromDecoded(){
    const seed = document.getElementById("decodedSeedOutput").value.trim();
    if(!seed){
        alert("No decoded seed words found.");
        return;
    }

    generateHighResQR(
        "decodedSeedQRCanvas",
        seed,
        "standard_seed_print.png"
    );
}
</script>
</body>
</html>







