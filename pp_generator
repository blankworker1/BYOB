import secrets
import hashlib
import string
import io
import time

import qrcode
import picamera

def get_camera_entropy(num_frames=8):
    """
    Collect entropy from the Pi camera by XORing multiple small frames.
    Returns 32 bytes of hashed entropy.
    """
    camera = picamera.PiCamera()
    camera.resolution = (320, 240)  # small frame for speed
    camera.framerate = 30

    # Warm up the camera
    time.sleep(2)

    frames = []

    for _ in range(num_frames):
        stream = io.BytesIO()
        camera.capture(stream, format='rgb', use_video_port=True)
        frames.append(stream.getvalue())
        time.sleep(0.03)

    camera.close()

    # XOR frames to isolate sensor noise
    noise = bytearray(frames[0])
    for frame in frames[1:]:
        noise = bytearray(a ^ b for a, b in zip(noise, frame))

    # Ensure the noise is at least 32 bytes
    if len(noise) < 32:
        raise ValueError("Insufficient entropy collected from camera frames.")

    # Hash the noise for uniform 32-byte entropy
    return hashlib.sha256(noise).digest()



def generate_secure_passphrase(length=24):
    """
    Generates a secure passphrase using OS CSPRNG and camera entropy.
    Returns a readable passphrase string.
    """
    os_entropy = secrets.token_bytes(32)
    camera_entropy = get_camera_entropy()

    # Combine entropy sources
    combined_seed = hashlib.sha256(os_entropy + camera_entropy).digest()

    # Map to readable passphrase
    alphabet = string.ascii_letters + string.digits
    alphabet_len = len(alphabet)
    seed_int = int.from_bytes(combined_seed, 'big')
    return "".join(alphabet[seed_int % alphabet_len] for _ in range(length))


def create_qr(data, filename="passphrase_qr.png"):
    """Generates a QR code encoding the passphrase as plain text."""
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(data)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    img.save(filename)
    print(f"QR code saved as {filename}")


if __name__ == "__main__":
    # Option: whether to print passphrase on screen
    show_passphrase = True

    passphrase = generate_secure_passphrase(length=24)

    if show_passphrase:
        print(f"Your Secret Passphrase: {passphrase}")

    create_qr(passphrase)









