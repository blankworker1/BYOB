import secrets
import hashlib
import string
import io
import time
import qrcode
import picamera

def get_camera_entropy(num_frames=8):
"""Collect entropy from the Pi camera by XORing multiple small frames."""
camera = None
try:
camera = picamera.PiCamera()
camera.resolution = (320, 240)
camera.framerate = 30
time.sleep(2)

frames = []  
    for _ in range(num_frames):  
        stream = io.BytesIO()  
        camera.capture(stream, format='rgb', use_video_port=True)  
        frames.append(stream.getvalue())  
        time.sleep(0.03)  

    if len(frames) < num_frames:  
        raise ValueError("Not enough frames captured from the camera.")  

    # XOR frames to isolate sensor noise  
    noise = bytearray(frames[0])  
    for frame in frames[1:]:  
        noise = bytearray(a ^ b for a, b in zip(noise, frame))  

    if len(noise) < 32:  
        raise ValueError("Insufficient entropy collected from camera frames.")  

    return hashlib.sha256(noise).digest()  
except Exception as e:  
    print(f"An error occurred while capturing camera entropy: {e}")  
    raise  
finally:  
    if camera:  
        camera.close()

def generate_secure_passphrase(length=24):
"""Generates a secure passphrase using OS CSPRNG and camera entropy."""
os_entropy = secrets.token_bytes(32)
camera_entropy = get_camera_entropy()

combined_seed = hashlib.sha256(os_entropy + camera_entropy).digest()  

alphabet = string.ascii_letters + string.digits  
alphabet_len = len(alphabet)  
seed_int = int.from_bytes(combined_seed, 'big')  

passphrase_chars = []  
for _ in range(length):  
    index = seed_int % alphabet_len  
    passphrase_chars.append(alphabet[index])  
    # CONSUME the seed to get a new index for the next character  
    seed_int //= alphabet_len  
      
return "".join(passphrase_chars)

def create_qr(data, filename="passphrase_qr.png"):
"""Generates a QR code encoding the passphrase as plain text."""
qr = qrcode.QRCode(version=1, box_size=10, border=5)
qr.add_data(data)
qr.make(fit=True)
img = qr.make_image(fill_color="black", back_color="white")
img.save(filename)
print(f"QR code saved as {filename}")

if name == "main":
show_passphrase = True
passphrase = generate_secure_passphrase(length=24)
if show_passphrase:
print(f"Your Secret Passphrase: {passphrase}")
create_qr(passphrase)



from the camera.")

        # XOR frames to isolate sensor noise
        noise = bytearray(frames[0])
        for frame in frames[1:]:
            noise = bytearray(a ^ b for a, b in zip(noise, frame))

        # Ensure the noise is at least 32 bytes
        if len(noise) < 32:
            raise ValueError("Insufficient entropy collected from camera frames.")

        # Hash the noise for uniform 32-byte entropy
        return hashlib.sha256(noise).digest()

    except Exception as e:
        print(f"An error occurred while capturing camera entropy: {e}")
        raise



def generate_secure_passphrase(length=24):
    """
    Generates a secure passphrase using OS CSPRNG and camera entropy.
    Returns a readable passphrase string.
    """
    os_entropy = secrets.token_bytes(32)
    camera_entropy = get_camera_entropy()

    # Combine entropy sources
    combined_seed = hashlib.sha256(os_entropy + camera_entropy).digest()

    # Map to readable passphrase
    alphabet = string.ascii_letters + string.digits
    alphabet_len = len(alphabet)
    seed_int = int.from_bytes(combined_seed, 'big')
    return "".join(alphabet[seed_int % alphabet_len] for _ in range(length))


def create_qr(data, filename="passphrase_qr.png"):
    """Generates a QR code encoding the passphrase as plain text."""
    qr = qrcode.QRCode(version=1, box_size=10, border=5)
    qr.add_data(data)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    img.save(filename)
    print(f"QR code saved as {filename}")


if __name__ == "__main__":
    # Option: whether to print passphrase on screen
    show_passphrase = True

    passphrase = generate_secure_passphrase(length=24)

    if show_passphrase:
        print(f"Your Secret Passphrase: {passphrase}")

    create_qr(passphrase)









