<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BYOB One - Minimal Wallet</title>
<style>
body { font-family: sans-serif; max-width:480px; margin:auto; padding:20px; }
.screen { display:none; }
.screen.active { display:block; }
input, button, textarea { font-size:16px; padding:8px; margin:5px 0; width:100%; box-sizing:border-box; }
canvas { display:block; margin:10px auto; }
.network-toggle { margin-bottom:10px; }
#xpubScanner, #destScanner { width:100%; height:300px; display:none; border:1px solid #ccc; margin-top:10px; }
.warning { color:red; font-size:14px; margin-top:5px; }
#debugLog { background:#f0f0f0; padding:10px; margin-top:10px; font-size:12px; font-family:monospace; white-space:pre-wrap; word-wrap:break-word; }
</style>
</head>
<body>

<h2>BYOB One – Minimal Wallet</h2>

<div class="network-toggle">
  <label><input type="radio" name="network" value="mainnet"> Mainnet</label>
  <label><input type="radio" name="network" value="testnet" checked> Testnet</label>
</div>

<!-- Wallet Screen -->
<div id="walletScreen" class="screen active">

  <div id="xpubImportSection">
    <input type="text" id="xpubInput" placeholder="Paste XPUB here">
    <button onclick="saveXpub()">Save XPUB</button>
    <button onclick="startXpubScan()">Scan XPUB QR</button>
    <div id="xpubScanner"></div>
    <div id="cameraWarning" class="warning"></div>
  </div>

  <div id="walletInfoSection" style="display:none;">
    <p><strong>Balance:</strong> <span id="balanceDisplay"></span></p>
    <p><strong>Next Receive Address:</strong> <span id="receiveAddress"></span></p>
    <canvas id="receiveQR" width="220" height="220"></canvas>
    <button onclick="goToSend()">Send BTC</button>
  </div>

  <div id="debugLog"></div>

</div>

<!-- Send Screen -->
<div id="sendScreen" class="screen">
  <p><strong>Destination Address:</strong></p>
  <input type="text" id="destAddress" placeholder="Paste or scan address">
  <button onclick="startDestScan()">Scan Destination QR</button>
  <div id="destScanner"></div>
  <div id="destWarning" class="warning"></div>

  <p><strong>Amount (sats):</strong></p>
  <input type="number" id="sendAmount" placeholder="Satoshis">

  <p><strong>Fee rate (sat/vbyte):</strong></p>
  <input type="range" id="feeSlider" min="1" max="200" value="10" oninput="document.getElementById('feeValue').innerText = this.value">
  <span id="feeValue">10</span> sat/vB

  <button onclick="buildTx()">Build TX</button>
  <button onclick="goToWallet()">Back</button>
</div>

<!-- Sign Screen -->
<div id="signScreen" class="screen">
  <p>Unsigned TX hex:</p>
  <textarea id="unsignedTx" rows="6"></textarea>
  <p>Sign on Seedsigner and paste signed TX here:</p>
  <textarea id="signedTx" rows="6"></textarea>
  <button onclick="broadcastTx()">Broadcast TX</button>
  <button onclick="goToWallet()">Back</button>
  <div id="txStatus"></div>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js"></script>
<script src="https://unpkg.com/bip32@2.0.6/browser.js"></script>
<script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<script>
// Debug logger
function logDebug(msg) {
  const log = document.getElementById("debugLog");
  if (log) {
    const timestamp = new Date().toISOString().substr(11,12);
    log.innerHTML += timestamp + ": " + msg + "\n";
    log.scrollTop = log.scrollHeight;
  }
  console.log(msg);
}

// Global variables
let currentNetwork = "testnet";
let derivedAddresses = [];
let utxos = [];

// Wait for all libraries to load
let checkLibrariesInterval = setInterval(() => {
  if (typeof bitcoin !== 'undefined' && typeof bip32 !== 'undefined' && typeof buffer !== 'undefined') {
    clearInterval(checkLibrariesInterval);
    logDebug("All libraries loaded");
    initApp();
  }
}, 100);

function initApp() {
  logDebug("Initializing app...");
  
  window.Buffer = buffer.Buffer;
  logDebug("Buffer: " + (window.Buffer ? "✓" : "✗"));
  logDebug("bitcoin: " + (typeof bitcoin !== 'undefined' ? "✓" : "✗"));
  logDebug("bip32: " + (typeof bip32 !== 'undefined' ? "✓" : "✗"));

  const walletScreen = document.getElementById("walletScreen");
  const sendScreen = document.getElementById("sendScreen");
  const signScreen = document.getElementById("signScreen");

  // NETWORK TOGGLE
  document.querySelectorAll('input[name="network"]').forEach(radio => {
    radio.addEventListener("change", function() {
      currentNetwork = this.value;
      logDebug("Network changed to: " + currentNetwork);
      loadWallet();
    });
  });

  function getNetworkObject() {
    return currentNetwork === "mainnet" ? bitcoin.networks.bitcoin : bitcoin.networks.testnet;
  }

  function getStorageKey() {
    return currentNetwork === "mainnet" ? "byob_xpub_mainnet" : "byob_xpub_testnet";
  }

  function getApiBase() {
    return currentNetwork === "mainnet" ? "https://mempool.space/api" : "https://mempool.space/testnet/api";
  }

  // SCREEN CONTROL
  function showScreen(screen) {
    walletScreen.classList.remove("active");
    sendScreen.classList.remove("active");
    signScreen.classList.remove("active");
    screen.classList.add("active");
  }
  window.goToSend = () => showScreen(sendScreen);
  window.goToWallet = () => showScreen(walletScreen);
  window.goToSign = () => showScreen(signScreen);

  // XPUB HANDLING
  window.saveXpub = function() {
    logDebug("=== saveXpub() called ===");
    const xpubInput = document.getElementById("xpubInput");
    logDebug("Input element: " + (xpubInput ? "found" : "NOT FOUND"));
    
    const xpub = xpubInput ? xpubInput.value.trim() : "";
    logDebug("XPUB length: " + xpub.length);
    logDebug("XPUB preview: " + (xpub ? xpub.substring(0,20) + "..." : "EMPTY"));
    
    if (!xpub) {
      logDebug("XPUB is empty - showing alert");
      alert("Enter XPUB");
      return;
    }
    
    try {
      const storageKey = getStorageKey();
      logDebug("Storage key: " + storageKey);
      
      localStorage.setItem(storageKey, xpub);
      logDebug("✓ XPUB saved to localStorage");
      
      const verification = localStorage.getItem(storageKey);
      logDebug("Verification read: " + (verification ? "✓" : "✗"));
      
      logDebug("Calling loadWallet()...");
      loadWallet();
    }
    catch (err) {
      logDebug("ERROR: " + err.message);
      logDebug("Stack: " + err.stack);
      alert("Error saving/loading XPUB: " + err.message);
    }
  }

  window.startXpubScan = function() {
    logDebug("startXpubScan called");
    const scannerDiv = document.getElementById("xpubScanner");
    const warningDiv = document.getElementById("cameraWarning");
    scannerDiv.style.display = "block";
    warningDiv.innerText = "";

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      warningDiv.innerText = "Camera not supported.";
      logDebug("Camera not supported");
      return;
    }

    const html5QrCode = new Html5Qrcode("xpubScanner");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      decodedText => {
        html5QrCode.stop().then(()=>{
          scannerDiv.style.display="none";
          document.getElementById("xpubInput").value = decodedText.trim();
          logDebug("QR scanned: " + decodedText.substring(0,20) + "...");
          window.saveXpub();
        });
      }, err=>{}
    ).catch(err => { 
      warningDiv.innerText="Cannot start camera. Use HTTPS."; 
      logDebug("Camera error: " + err);
    });
  }

  // DESTINATION SCANNER
  window.startDestScan = function() {
    const scannerDiv = document.getElementById("destScanner");
    const warningDiv = document.getElementById("destWarning");
    scannerDiv.style.display = "block";
    warningDiv.innerText = "";

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      warningDiv.innerText = "Camera not supported.";
      return;
    }

    const html5QrCode = new Html5Qrcode("destScanner");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      decodedText => {
        html5QrCode.stop().then(()=>{
          scannerDiv.style.display="none";
          document.getElementById("destAddress").value = decodedText.trim();
        });
      }, err=>{}
    ).catch(err => { warningDiv.innerText="Cannot start camera. Use HTTPS."; console.error(err); });
  }

  // LOAD WALLET
  async function loadWallet() {
    logDebug("=== loadWallet() called ===");
    const storageKey = getStorageKey();
    const stored = localStorage.getItem(storageKey);
    logDebug("Storage key: " + storageKey);
    logDebug("Stored value: " + (stored ? stored.substring(0,20) + "..." : "NULL"));
    
    if (!stored) {
      logDebug("No XPUB in storage - showing import screen");
      document.getElementById("xpubImportSection").style.display = "block";
      document.getElementById("walletInfoSection").style.display = "none";
      return;
    }
    
    logDebug("XPUB found - switching to wallet screen");
    document.getElementById("xpubImportSection").style.display = "none";
    document.getElementById("walletInfoSection").style.display = "block";
    document.getElementById("balanceDisplay").innerText = "Loading...";
    document.getElementById("receiveAddress").innerText = "Deriving...";
    
    try {
      logDebug("Starting deriveAddresses...");
      await deriveAddresses(stored);
      logDebug("Starting fetchBalance...");
      await fetchBalance();
      logDebug("Wallet loaded successfully");
    }
    catch (err) {
      logDebug("ERROR in loadWallet: " + err.message);
      logDebug("Stack: " + err.stack);
      alert("Error loading wallet: " + err.message);
    }
  }

  async function deriveAddresses(xpub) {
    logDebug("=== deriveAddresses() called ===");
    derivedAddresses = [];
    const network = getNetworkObject();
    logDebug("Network: " + (network === bitcoin.networks.testnet ? "testnet" : "mainnet"));
    
    try {
      logDebug("Parsing XPUB with bip32...");
      const node = bip32.fromBase58(xpub, network);
      logDebug("✓ XPUB parsed successfully");
      
      for (let i = 0; i < 20; i++) {
        const child = node.derive(0).derive(i);
        const { address } = bitcoin.payments.p2wpkh({ pubkey: child.publicKey, network: network });
        derivedAddresses.push(address);
        if (i === 0) {
          logDebug("First address: " + address);
        }
      }
      logDebug("✓ Derived " + derivedAddresses.length + " addresses");
    } catch(error) {
      logDebug("ERROR deriving addresses: " + error.message);
      logDebug("Stack: " + error.stack);
      alert("Invalid XPUB: " + error.message);
    }
  }

  async function fetchBalance() {
    logDebug("=== fetchBalance() called ===");
    utxos = [];
    let total = 0;
    const api = getApiBase();
    logDebug("API: " + api);
    logDebug("Checking " + derivedAddresses.length + " addresses...");
    
    for (let i = 0; i < derivedAddresses.length; i++) {
      const address = derivedAddresses[i];
      try {
        const url = `${api}/address/${address}/utxo`;
        logDebug(`[${i}] Fetching: ${address.substring(0,10)}...`);
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.length > 0) {
          logDebug(`[${i}] Found ${data.length} UTXO(s)`);
          data.forEach(u => {
            utxos.push({txid: u.txid, vout: u.vout, value: u.value, address: address});
            total += u.value;
          });
        }
      } catch(err) {
        logDebug(`[${i}] Error: ${err.message}`);
      }
    }
    
    logDebug("✓ Total balance: " + total + " sats");
    logDebug("✓ Total UTXOs: " + utxos.length);
    document.getElementById("balanceDisplay").innerText = total.toLocaleString() + " sats";
    displayNextReceive();
  }

  function displayNextReceive() {
    logDebug("=== displayNextReceive() called ===");
    const next = derivedAddresses[0];
    logDebug("Receive address: " + next);
    document.getElementById("receiveAddress").innerText = next;
    
    try {
      QRCode.toCanvas(document.getElementById("receiveQR"), next, { width: 220 });
      logDebug("✓ QR code generated");
    } catch(err) {
      logDebug("ERROR generating QR: " + err.message);
    }
  }

  // TX BUILDER
  window.buildTx = () => {
    logDebug("=== buildTx() called ===");
    const dest = document.getElementById("destAddress").value.trim();
    const amount = parseInt(document.getElementById("sendAmount").value.trim());
    const feeRate = parseInt(document.getElementById("feeSlider").value.trim());
    
    logDebug("Dest: " + dest);
    logDebug("Amount: " + amount);
    logDebug("Fee rate: " + feeRate);
    
    if (!dest || !amount) {
      logDebug("Missing destination or amount");
      return alert("Enter destination and amount");
    }

    try {
      const psbt = new bitcoin.Psbt({network: getNetworkObject()});
      let inputTotal = 0;
      
      for (let u of utxos) {
        if (inputTotal >= amount + 1000) break;
        psbt.addInput({
          hash: u.txid,
          index: u.vout,
          witnessUtxo: {
            script: bitcoin.payments.p2wpkh({address: u.address, network: getNetworkObject()}).output,
            value: u.value
          }
        });
        inputTotal += u.value;
      }
      
      logDebug("Input total: " + inputTotal);
      
      if (inputTotal < amount) {
        logDebug("Insufficient balance");
        return alert("Insufficient balance");
      }
      
      psbt.addOutput({address: dest, value: amount});
      psbt.addOutput({address: derivedAddresses[0], value: inputTotal - amount});
      
      const hex = psbt.toHex();
      document.getElementById("unsignedTx").value = hex;
      logDebug("✓ TX built, hex length: " + hex.length);
      window.goToSign();
    } catch(err) {
      logDebug("ERROR building TX: " + err.message);
      alert("Error building TX: " + err.message);
    }
  };

  window.broadcastTx = async () => {
    logDebug("=== broadcastTx() called ===");
    const signedHex = document.getElementById("signedTx").value.trim();
    if (!signedHex) {
      logDebug("No signed TX");
      return alert("Paste signed TX hex");
    }
    
    const api = getApiBase();
    logDebug("Broadcasting to: " + api);
    
    try {
      const res = await fetch(`${api}/tx`, {
        method: "POST",
        headers: {"Content-Type": "text/plain"},
        body: signedHex
      });
      
      logDebug("Response status: " + res.status);
      const statusText = res.ok ? "✓ TX broadcasted!" : "✗ Error broadcasting TX";
      document.getElementById("txStatus").innerText = statusText;
      logDebug(statusText);
    } catch(err) {
      logDebug("ERROR: " + err.message);
      document.getElementById("txStatus").innerText = "Error: " + err.message;
    }
  };

  logDebug("Starting initial loadWallet()...");
  loadWallet();
}
</script>

</body>
</html>
