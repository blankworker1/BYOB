<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BYOB One - Minimal Wallet</title>
<style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 20px;
  max-width: 480px;
  margin-left: auto;
  margin-right: auto;
}
.screen { display: none; }
.screen.active { display: block; }
input, button { font-size: 16px; padding: 8px; margin: 5px 0; width: 100%; }
canvas { display: block; margin: 10px auto; }
.network-toggle { margin-bottom: 10px; }
#xpubScanner { width: 100%; height: 300px; display: none; margin-top: 10px; border:1px solid #ccc; }
</style>
</head>
<body>

<h2>BYOB One – Minimal Wallet</h2>

<div class="network-toggle">
  <label><input type="radio" name="network" value="mainnet" checked> Mainnet</label>
  <label><input type="radio" name="network" value="testnet"> Testnet</label>
</div>

<!-- Wallet Screen -->
<div id="walletScreen" class="screen active">

  <div id="xpubImportSection">
    <input type="text" id="xpubInput" placeholder="Paste XPUB here">
    <button onclick="saveXpub()">Save XPUB</button>
    <button onclick="startXpubScan()">Scan XPUB QR</button>
    <div id="xpubScanner"></div>
  </div>

  <div id="walletInfoSection" style="display:none;">
    <p><strong>Balance:</strong> <span id="balanceDisplay"></span></p>
    <p><strong>Next Receive Address:</strong> <span id="receiveAddress"></span></p>
    <canvas id="receiveQR" width="220" height="220"></canvas>
    <button onclick="goToSend()">Send BTC</button>
  </div>

</div>

<!-- Send Screen -->
<div id="sendScreen" class="screen">
  <p>Send Screen – Coming Soon</p>
  <button onclick="goToWallet()">Back</button>
</div>

<!-- Sign Screen -->
<div id="signScreen" class="screen">
  <p>Sign Screen – Coming Soon</p>
  <button onclick="goToWallet()">Back</button>
</div>

<!-- 1️⃣ External Libraries -->
<script src="https://unpkg.com/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js"></script>
<script src="https://unpkg.com/bip32@2.0.6/browser.js"></script>
<script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<!-- 2️⃣ Main Wallet Script -->
<script>
window.Buffer = window.buffer.Buffer;

const { networks, payments } = bitcoin;
const bip32 = window.bip32;

let currentNetwork = "mainnet";
let derivedAddresses = [];
let utxos = [];

const walletScreen = document.getElementById("walletScreen");
const sendScreen = document.getElementById("sendScreen");
const signScreen = document.getElementById("signScreen");

// ------------------
// SCREEN CONTROL
// ------------------
function showScreen(screen) {
  walletScreen.classList.remove("active");
  sendScreen.classList.remove("active");
  signScreen.classList.remove("active");
  screen.classList.add("active");
}
function goToSend() { showScreen(sendScreen); }
function goToWallet() { showScreen(walletScreen); }
function goToSign() { showScreen(signScreen); }

// ------------------
// NETWORK TOGGLE
// ------------------
document.querySelectorAll('input[name="network"]').forEach(radio => {
  radio.addEventListener("change", function() {
    currentNetwork = this.value;
    loadWallet();
  });
});

function getNetworkObject() {
  return currentNetwork === "mainnet"
    ? networks.bitcoin
    : networks.testnet;
}

function getApiBase() {
  return currentNetwork === "mainnet"
    ? "https://mempool.space/api"
    : "https://mempool.space/testnet/api";
}

function getStorageKey() {
  return currentNetwork === "mainnet"
    ? "byob_xpub_mainnet"
    : "byob_xpub_testnet";
}

// ------------------
// XPUB HANDLING
// ------------------
function saveXpub() {
  const xpub = document.getElementById("xpubInput").value.trim();
  if (!xpub) return alert("Enter XPUB");

  try {
    localStorage.setItem(getStorageKey(), xpub);
    loadWallet();
  } catch (err) {
    alert("Error saving/loading XPUB: " + err.message);
  }
}

// ------------------
// QR SCANNER FOR XPUB
// ------------------
function startXpubScan() {
  console.log("Scan button clicked");

  const scannerDiv = document.getElementById("xpubScanner");
  scannerDiv.style.display = "block";

  const html5QrCode = new Html5Qrcode("xpubScanner");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      console.log("QR decoded:", decodedText);
      html5QrCode.stop().then(() => {
        scannerDiv.style.display = "none";
        document.getElementById("xpubInput").value = decodedText.trim();
        saveXpub();
      }).catch(err => console.error("Stop failed:", err));
    },
    (errorMessage) => {
      // optional: scan errors
    }
  ).catch(err => console.error("Unable to start QR scanner:", err));
}

// ------------------
// LOAD WALLET
// ------------------
async function loadWallet() {
  const stored = localStorage.getItem(getStorageKey());
  if (!stored) {
    document.getElementById("xpubImportSection").style.display = "block";
    document.getElementById("walletInfoSection").style.display = "none";
    return;
  }
  document.getElementById("xpubImportSection").style.display = "none";
  document.getElementById("walletInfoSection").style.display = "block";

  document.getElementById("balanceDisplay").innerText = "Loading...";
  document.getElementById("receiveAddress").innerText = "Deriving...";

  try {
    await deriveAddresses(stored);
    await fetchBalance();
  } catch (err) {
    alert("Error loading wallet: " + err.message);
  }
}

// ------------------
// DERIVE ADDRESSES
// ------------------
async function deriveAddresses(xpub) {
  derivedAddresses = [];
  const network = getNetworkObject();

  try {
    const node = bip32.fromBase58(xpub, network);
    for (let i = 0; i < 20; i++) {
      const child = node.derive(0).derive(i);
      const { address } = payments.p2wpkh({ pubkey: child.publicKey, network: network });
      derivedAddresses.push(address);
    }
  } catch (error) {
    alert("Invalid XPUB: " + error.message);
  }
}

// ------------------
// FETCH BALANCE
// ------------------
async function fetchBalance() {
  utxos = [];
  let total = 0;
  const api = getApiBase();

  for (let address of derivedAddresses) {
    try {
      const res = await fetch(`${api}/address/${address}/utxo`);
      const data = await res.json();
      if (data.length > 0) {
        data.forEach(u => {
          utxos.push({ txid: u.txid, vout: u.vout, value: u.value, address: address });
          total += u.value;
        });
      }
    } catch (err) {
      console.error("Error fetching balance for address", address, err);
    }
  }

  document.getElementById("balanceDisplay").innerText = total.toLocaleString() + " sats";
  displayNextReceive();
}

// ------------------
// DISPLAY NEXT RECEIVE ADDRESS
// ------------------
function displayNextReceive() {
  const next = derivedAddresses[0];
  document.getElementById("receiveAddress").innerText = next;
  QRCode.toCanvas(document.getElementById("receiveQR"), next, { width: 220 });
}

// ------------------
loadWallet();

</script>

</body>
</html>





