<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BYOB One - Minimal Wallet</title>
<style>
body { font-family: sans-serif; max-width:480px; margin:auto; padding:20px; }
.screen { display:none; }
.screen.active { display:block; }
input, button, textarea { font-size:16px; padding:8px; margin:5px 0; width:100%; box-sizing:border-box; }
canvas { display:block; margin:10px auto; }
.network-toggle { margin-bottom:10px; }
#xpubScanner, #destScanner { width:100%; height:300px; display:none; border:1px solid #ccc; margin-top:10px; }
.warning { color:red; font-size:14px; margin-top:5px; }
.loading { color: blue; font-weight: bold; padding:10px; background:#f0f0f0; margin:10px 0; }
</style>
</head>
<body>

<h2>BYOB One – Minimal Wallet</h2>

<div id="libraryStatus" class="loading">Loading libraries... Please wait.</div>

<div class="network-toggle">
  <label><input type="radio" name="network" value="mainnet"> Mainnet</label>
  <label><input type="radio" name="network" value="testnet" checked> Testnet</label>
</div>

<!-- Wallet Screen -->
<div id="walletScreen" class="screen active">

  <div id="xpubImportSection">
    <input type="text" id="xpubInput" placeholder="Paste XPUB here">
    <button id="saveBtn" onclick="saveXpub()" disabled>Save XPUB (loading...)</button>
    <button onclick="startXpubScan()">Scan XPUB QR</button>
    <div id="xpubScanner"></div>
    <div id="cameraWarning" class="warning"></div>
  </div>

  <div id="walletInfoSection" style="display:none;">
    <p><strong>Balance:</strong> <span id="balanceDisplay"></span></p>
    <p><strong>Next Receive Address:</strong> <span id="receiveAddress"></span></p>
    <canvas id="receiveQR" width="220" height="220"></canvas>
    <button onclick="goToSend()">Send BTC</button>
  </div>

</div>

<!-- Send Screen -->
<div id="sendScreen" class="screen">
  <p><strong>Destination Address:</strong></p>
  <input type="text" id="destAddress" placeholder="Paste or scan address">
  <button onclick="startDestScan()">Scan Destination QR</button>
  <div id="destScanner"></div>
  <div id="destWarning" class="warning"></div>

  <p><strong>Amount (sats):</strong></p>
  <input type="number" id="sendAmount" placeholder="Satoshis">

  <p><strong>Fee rate (sat/vbyte):</strong></p>
  <input type="range" id="feeSlider" min="1" max="200" value="10" oninput="document.getElementById('feeValue').innerText = this.value">
  <span id="feeValue">10</span> sat/vB

  <button onclick="buildTx()">Build TX</button>
  <button onclick="goToWallet()">Back</button>
</div>

<!-- Sign Screen -->
<div id="signScreen" class="screen">
  <p>Unsigned TX hex:</p>
  <textarea id="unsignedTx" rows="6"></textarea>
  <p>Sign on Seedsigner and paste signed TX here:</p>
  <textarea id="signedTx" rows="6"></textarea>
  <button onclick="broadcastTx()">Broadcast TX</button>
  <button onclick="goToWallet()">Back</button>
  <div id="txStatus"></div>
</div>

<!-- Try multiple CDN sources -->
<script>
// Load scripts dynamically with fallbacks
const scripts = [
  {
    name: 'buffer',
    urls: [
      'https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.js',
      'https://unpkg.com/buffer@6.0.3/index.js'
    ],
    check: () => typeof buffer !== 'undefined'
  },
  {
    name: 'bip32',
    urls: [
      'https://cdn.jsdelivr.net/npm/bip32@2.0.6/src/bip32.min.js',
      'https://unpkg.com/bip32@2.0.6/browser.js'
    ],
    check: () => typeof bip32 !== 'undefined'
  },
  {
    name: 'bitcoinjs',
    urls: [
      'https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js',
      'https://unpkg.com/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js'
    ],
    check: () => typeof bitcoin !== 'undefined'
  },
  {
    name: 'qrcode',
    urls: [
      'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js'
    ],
    check: () => typeof QRCode !== 'undefined'
  },
  {
    name: 'html5-qrcode',
    urls: [
      'https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js'
    ],
    check: () => typeof Html5Qrcode !== 'undefined'
  }
];

let currentScriptIndex = 0;
let currentUrlIndex = 0;

function updateLibraryStatus(msg) {
  document.getElementById('libraryStatus').innerHTML = msg;
}

function loadNextScript() {
  if (currentScriptIndex >= scripts.length) {
    // All scripts loaded successfully
    updateLibraryStatus('✓ All libraries loaded successfully!');
    document.getElementById('libraryStatus').style.color = 'green';
    initApp();
    return;
  }

  const scriptInfo = scripts[currentScriptIndex];
  updateLibraryStatus(`Loading ${scriptInfo.name}... (${currentScriptIndex + 1}/${scripts.length})`);

  // Check if already loaded
  if (scriptInfo.check()) {
    currentScriptIndex++;
    currentUrlIndex = 0;
    loadNextScript();
    return;
  }

  // Try to load from current URL
  if (currentUrlIndex >= scriptInfo.urls.length) {
    // All URLs failed for this script
    updateLibraryStatus(`✗ Failed to load ${scriptInfo.name}. Please check your internet connection and refresh.`);
    document.getElementById('libraryStatus').style.color = 'red';
    return;
  }

  const script = document.createElement('script');
  script.src = scriptInfo.urls[currentUrlIndex];
  
  script.onload = function() {
    // Wait a bit and check if it loaded
    setTimeout(() => {
      if (scriptInfo.check()) {
        // Success, move to next script
        currentScriptIndex++;
        currentUrlIndex = 0;
        loadNextScript();
      } else {
        // Try next URL for same script
        currentUrlIndex++;
        loadNextScript();
      }
    }, 200);
  };

  script.onerror = function() {
    // Try next URL
    currentUrlIndex++;
    loadNextScript();
  };

  document.head.appendChild(script);
}

// Start loading
loadNextScript();

// Global variables
let currentNetwork = "testnet";
let derivedAddresses = [];
let utxos = [];
let appReady = false;

function initApp() {
  console.log("Initializing app...");
  appReady = true;
  
  window.Buffer = buffer.Buffer;

  // Enable the save button
  const saveBtn = document.getElementById("saveBtn");
  saveBtn.disabled = false;
  saveBtn.innerText = "Save XPUB";

  const walletScreen = document.getElementById("walletScreen");
  const sendScreen = document.getElementById("sendScreen");
  const signScreen = document.getElementById("signScreen");

  // NETWORK TOGGLE
  document.querySelectorAll('input[name="network"]').forEach(radio => {
    radio.addEventListener("change", function() {
      currentNetwork = this.value;
      loadWallet();
    });
  });

  function getNetworkObject() {
    return currentNetwork === "mainnet" ? bitcoin.networks.bitcoin : bitcoin.networks.testnet;
  }

  function getStorageKey() {
    return currentNetwork === "mainnet" ? "byob_xpub_mainnet" : "byob_xpub_testnet";
  }

  function getApiBase() {
    return currentNetwork === "mainnet" ? "https://mempool.space/api" : "https://mempool.space/testnet/api";
  }

  // SCREEN CONTROL
  function showScreen(screen) {
    walletScreen.classList.remove("active");
    sendScreen.classList.remove("active");
    signScreen.classList.remove("active");
    screen.classList.add("active");
  }
  window.goToSend = () => showScreen(sendScreen);
  window.goToWallet = () => showScreen(walletScreen);
  window.goToSign = () => showScreen(signScreen);

  // XPUB HANDLING
  window.saveXpub = function() {
    if (!appReady) {
      alert("Please wait for libraries to load");
      return;
    }
    
    const xpubInput = document.getElementById("xpubInput");
    const xpub = xpubInput ? xpubInput.value.trim() : "";
    
    if (!xpub) {
      alert("Enter XPUB");
      return;
    }
    
    try {
      const storageKey = getStorageKey();
      localStorage.setItem(storageKey, xpub);
      loadWallet();
    }
    catch (err) {
      alert("Error saving/loading XPUB: " + err.message);
    }
  }

  window.startXpubScan = function() {
    const scannerDiv = document.getElementById("xpubScanner");
    const warningDiv = document.getElementById("cameraWarning");
    scannerDiv.style.display = "block";
    warningDiv.innerText = "";

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      warningDiv.innerText = "Camera not supported.";
      return;
    }

    const html5QrCode = new Html5Qrcode("xpubScanner");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      decodedText => {
        html5QrCode.stop().then(()=>{
          scannerDiv.style.display="none";
          document.getElementById("xpubInput").value = decodedText.trim();
          window.saveXpub();
        });
      }, err=>{}
    ).catch(err => { 
      warningDiv.innerText="Cannot start camera. Use HTTPS.";
    });
  }

  // DESTINATION SCANNER
  window.startDestScan = function() {
    const scannerDiv = document.getElementById("destScanner");
    const warningDiv = document.getElementById("destWarning");
    scannerDiv.style.display = "block";
    warningDiv.innerText = "";

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      warningDiv.innerText = "Camera not supported.";
      return;
    }

    const html5QrCode = new Html5Qrcode("destScanner");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      decodedText => {
        html5QrCode.stop().then(()=>{
          scannerDiv.style.display="none";
          document.getElementById("destAddress").value = decodedText.trim();
        });
      }, err=>{}
    ).catch(err => { warningDiv.innerText="Cannot start camera. Use HTTPS."; });
  }

  // LOAD WALLET
  async function loadWallet() {
    const storageKey = getStorageKey();
    const stored = localStorage.getItem(storageKey);
    
    if (!stored) {
      document.getElementById("xpubImportSection").style.display = "block";
      document.getElementById("walletInfoSection").style.display = "none";
      return;
    }
    
    document.getElementById("xpubImportSection").style.display = "none";
    document.getElementById("walletInfoSection").style.display = "block";
    document.getElementById("balanceDisplay").innerText = "Loading...";
    document.getElementById("receiveAddress").innerText = "Deriving...";
    
    try {
      await deriveAddresses(stored);
      await fetchBalance();
    }
    catch (err) {
      alert("Error loading wallet: " + err.message);
    }
  }

  async function deriveAddresses(xpub) {
    derivedAddresses = [];
    const network = getNetworkObject();
    
    try {
      const node = bip32.fromBase58(xpub, network);
      
      for (let i = 0; i < 20; i++) {
        const child = node.derive(0).derive(i);
        const { address } = bitcoin.payments.p2wpkh({ pubkey: child.publicKey, network: network });
        derivedAddresses.push(address);
      }
    } catch(error) {
      alert("Invalid XPUB: " + error.message);
      throw error;
    }
  }

  async function fetchBalance() {
    utxos = [];
    let total = 0;
    const api = getApiBase();
    
    for (let i = 0; i < derivedAddresses.length; i++) {
      const address = derivedAddresses[i];
      try {
        const url = `${api}/address/${address}/utxo`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.length > 0) {
          data.forEach(u => {
            utxos.push({txid: u.txid, vout: u.vout, value: u.value, address: address});
            total += u.value;
          });
        }
      } catch(err) {
        console.error("Error fetching", address, err);
      }
    }
    
    document.getElementById("balanceDisplay").innerText = total.toLocaleString() + " sats";
    displayNextReceive();
  }

  function displayNextReceive() {
    const next = derivedAddresses[0];
    document.getElementById("receiveAddress").innerText = next;
    
    try {
      QRCode.toCanvas(document.getElementById("receiveQR"), next, { width: 220 });
    } catch(err) {
      console.error("QR error:", err);
    }
  }

  // TX BUILDER
  window.buildTx = () => {
    const dest = document.getElementById("destAddress").value.trim();
    const amount = parseInt(document.getElementById("sendAmount").value.trim());
    const feeRate = parseInt(document.getElementById("feeSlider").value.trim());
    
    if (!dest || !amount) {
      return alert("Enter destination and amount");
    }

    try {
      const psbt = new bitcoin.Psbt({network: getNetworkObject()});
      let inputTotal = 0;
      
      for (let u of utxos) {
        if (inputTotal >= amount + 1000) break;
        psbt.addInput({
          hash: u.txid,
          index: u.vout,
          witnessUtxo: {
            script: bitcoin.payments.p2wpkh({address: u.address, network: getNetworkObject()}).output,
            value: u.value
          }
        });
        inputTotal += u.value;
      }
      
      if (inputTotal < amount) {
        return alert("Insufficient balance");
      }
      
      psbt.addOutput({address: dest, value: amount});
      psbt.addOutput({address: derivedAddresses[0], value: inputTotal - amount});
      
      const hex = psbt.toHex();
      document.getElementById("unsignedTx").value = hex;
      window.goToSign();
    } catch(err) {
      alert("Error building TX: " + err.message);
    }
  };

  window.broadcastTx = async () => {
    const signedHex = document.getElementById("signedTx").value.trim();
    if (!signedHex) {
      return alert("Paste signed TX hex");
    }
    
    const api = getApiBase();
    
    try {
      const res = await fetch(`${api}/tx`, {
        method: "POST",
        headers: {"Content-Type": "text/plain"},
        body: signedHex
      });
      
      const statusText = res.ok ? "✓ TX broadcasted!" : "✗ Error broadcasting TX";
      document.getElementById("txStatus").innerText = statusText;
    } catch(err) {
      document.getElementById("txStatus").innerText = "Error: " + err.message;
    }
  };

  loadWallet();
}
</script>

</body>
</html>
