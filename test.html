<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BYOB One - Debug Version</title>

<style>
body { font-family: sans-serif; max-width:480px; margin:auto; padding:20px; }
.status { background:#f0f0f0; padding:15px; margin:10px 0; font-size:14px; border-left:4px solid #333; }
.success { border-left-color: green; }
.error { border-left-color: red; }
.info { border-left-color: blue; }
input, button { font-size:16px; padding:10px; margin:10px 0; width:100%; box-sizing:border-box; }
</style>
</head>
<body>

<h2>BYOB One – Debug Test</h2>

<div id="status1" class="status">Step 1: Loading page...</div>
<div id="status2" class="status">Step 2: Waiting...</div>
<div id="status3" class="status">Step 3: Waiting...</div>
<div id="status4" class="status">Step 4: Waiting...</div>
<div id="status5" class="status">Step 5: Waiting...</div>

<input type="text" id="xpubInput" placeholder="Paste XPUB or TPUB here">
<button onclick="testSave()">Click to Test Save</button>

<div id="result" style="margin-top:20px;font-size:16px;font-weight:bold;"></div>

<!-- LIBRARIES (ORDER MATTERS) -->
<script src="js/buffer.min.js"></script>
<script src="js/bip32.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib-browser@5.1.7/bitcoinjs.min.js"></script>




<script>

/* ================================
   UI HELPER (DEFINE FIRST)
================================ */

function updateStatus(num, msg, type) {
  const el = document.getElementById("status" + num);
  if (!el) return;
  el.innerHTML = "Step " + num + ": " + msg;
  el.className = "status " + type;
}

/* ================================
   INITIAL SETUP
================================ */

updateStatus(1, "✓ Page loaded", "success");

// Expose libraries safely
window.Buffer = window.Buffer || window.buffer?.Buffer;
window.bip32 = window.bip32 || window.scureBip32;
window.bitcoin = window.bitcoin || window.bitcoinjs || window.Bitcoin;

/* ================================
   LIBRARY CHECK
================================ */

setTimeout(() => {

  const bufferOK = typeof window.Buffer !== "undefined";
  const bip32OK = typeof window.bip32 !== "undefined";
  const bitcoinOK = typeof window.bitcoin !== "undefined";

  if (bufferOK && bip32OK && bitcoinOK) {
    updateStatus(2, "✓ All libraries loaded", "success");
    testBitcoinEngine();
  } else {
    updateStatus(
      2,
      "✗ Library load failed: buffer=" + bufferOK +
      ", bip32=" + bip32OK +
      ", bitcoin=" + bitcoinOK,
      "error"
    );
  }

}, 500);

/* ================================
   TEST BITCOIN ENGINE
================================ */

function testBitcoinEngine() {
  try {
    const testNet = bitcoin.networks.testnet;

    updateStatus(3, "✓ Bitcoin engine functional", "success");
    updateStatus(4, "Ready to test! Enter XPUB.", "info");

  } catch (e) {
    updateStatus(3, "✗ Bitcoin engine failed: " + e.message, "error");
  }
}

/* ================================
   TEST XPUB
================================ */

function testSave() {

  updateStatus(4, "Testing save...", "info");

  const xpub = document.getElementById("xpubInput").value.trim();

  if (!xpub) {
    updateStatus(5, "✗ No XPUB entered", "error");
    return;
  }

  try {
    localStorage.setItem("test_xpub", xpub);
    updateStatus(5, "✓ localStorage works", "success");
  } catch (e) {
    updateStatus(5, "✗ localStorage error: " + e.message, "error");
    return;
  }

  let network;
  let versions;

  if (xpub.startsWith("xpub")) {
    network = bitcoin.networks.bitcoin;
    versions = { public: 0x0488b21e, private: 0x0488ade4 };
  } else if (xpub.startsWith("tpub")) {
    network = bitcoin.networks.testnet;
    versions = { public: 0x043587cf, private: 0x04358394 };
  } else {
    updateStatus(5, "✗ Unknown XPUB prefix", "error");
    return;
  }

  try {
     const node = bip32.HDKey.fromExtendedKey(xpub);

    const child = node.derive("m/0/0");

    const { address } = bitcoin.payments.p2wpkh({
      pubkey: child.publicKey,
      network: network
    });

    document.getElementById("result").innerHTML =
      "✅ XPUB valid<br><br>First address:<br>" + address;

    updateStatus(5, "✓ XPUB parsed and address derived", "success");

  } catch (e) {
    updateStatus(5, "✗ XPUB parsing error: " + e.message, "error");
  }
}


</script>

</body>
</html>
