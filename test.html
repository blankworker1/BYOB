<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BYOB One - Debug Version</title>
<style>
body { font-family: sans-serif; max-width:480px; margin:auto; padding:20px; }
.status { background:#f0f0f0; padding:15px; margin:10px 0; font-size:14px; border-left:4px solid #333; }
.success { border-left-color: green; }
.error { border-left-color: red; }
.info { border-left-color: blue; }
input, button { font-size:16px; padding:10px; margin:10px 0; width:100%; box-sizing:border-box; }
</style>
</head>
<body>

<h2>BYOB One ‚Äì Debug Test</h2>

<div id="status1" class="status">Step 1: Loading page...</div>
<div id="status2" class="status">Step 2: Waiting...</div>
<div id="status3" class="status">Step 3: Waiting...</div>
<div id="status4" class="status">Step 4: Waiting...</div>
<div id="status5" class="status">Step 5: Waiting...</div>

<input type="text" id="xpubInput" placeholder="Paste XPUB or TPUB here">
<button id="saveBtn" onclick="testSave()">Click to Test Save</button>

<div id="result" style="margin-top:20px; font-size:16px; font-weight:bold;"></div>

<!-- Libraries -->

<script src="js/buffer.min.js"></script>
<script>
  window.Buffer = window.Buffer || buffer?.Buffer || window.buffer?.Buffer;
  updateStatus(3, '‚úì Buffer initialized', 'success');
</script>

<script src="js/bip32.min.js"></script>
<script>
  // Expose scureBip32 globally
  window.bip32 = scureBip32;
</script>
  
<script src="js/bitcoinjs.min.js"></script>
<script>
  // Expose bitcoinjs-lib globally
  window.bitcoin = window.bitcoinjs || window.Bitcoin || null;
</script>
  
<script src="js/qrcode.min.js"></script>
<script src="js/html5-qrcode.min.js"></script>

<script>
function updateStatus(num, msg, type) {
  const el = document.getElementById('status' + num);
  el.innerHTML = 'Step ' + num + ': ' + msg;
  el.className = 'status ' + type;
}

updateStatus(1, '‚úì Page loaded', 'success');

// Step 2 & 3: Check libraries
setTimeout(() => {
  updateStatus(2, 'Checking libraries...', 'info');

  let checks = 0;
  const checkInterval = setInterval(() => {
    checks++;

    const bufferOK = typeof window.Buffer !== 'undefined';
    const bip32OK = typeof window.bip32 !== 'undefined';
    const bitcoinOK = typeof window.bitcoin !== 'undefined';

    if (bufferOK && bip32OK && bitcoinOK) {
      clearInterval(checkInterval);
      updateStatus(2, '‚úì All libraries loaded', 'success');
      window.Buffer = buffer.Buffer;
      updateStatus(3, '‚úì Buffer initialized', 'success');
      updateStatus(4, 'Ready to test! Enter XPUB and click button', 'info');
    } else if (checks > 50) {
      clearInterval(checkInterval);
      updateStatus(2, '‚úó Library timeout: buffer=' + bufferOK + ', bip32=' + bip32OK + ', bitcoin=' + bitcoinOK, 'error');
    }
  }, 100);
}, 500);

// Step 4 & 5: Test save and XPUB parsing
function testSave() {
  updateStatus(4, 'Testing save...', 'info');

  const xpub = document.getElementById('xpubInput').value.trim();

  if (!xpub) {
    updateStatus(5, '‚úó No XPUB entered!', 'error');
    document.getElementById('result').innerHTML = '‚ùå Please paste an XPUB first';
    return;
  }

  updateStatus(5, 'XPUB length: ' + xpub.length + ' chars', 'info');

  // Test localStorage
  try {
    localStorage.setItem('test_xpub', xpub);
    const retrieved = localStorage.getItem('test_xpub');

    if (retrieved === xpub) {
      updateStatus(5, '‚úì localStorage works!', 'success');
    } else {
      updateStatus(5, '‚úó localStorage failed verification', 'error');
      return;
    }
  } catch(e) {
    updateStatus(5, '‚úó localStorage error: ' + e.message, 'error');
    return;
  }

  // Determine network and BIP32 version
  let network, versions;
  if (xpub.startsWith('xpub')) {
    network = bitcoin.networks.bitcoin;
    versions = { public: 0x0488b21e, private: 0x0488ade4 };
  } else if (xpub.startsWith('tpub')) {
    network = bitcoin.networks.testnet;
    versions = { public: 0x043587cf, private: 0x04358394 };
  } else {
    updateStatus(5, '‚úó Unknown XPUB format', 'error');
    document.getElementById('result').innerHTML = '‚ùå XPUB must start with xpub (mainnet) or tpub (testnet)';
    return;
  }

  // Parse XPUB
  try {
    const node = scureBip32.HDKey.fromExtendedKey(xpub, { versions });

    document.getElementById('result').innerHTML =
      '‚úÖ SUCCESS! XPUB is valid!<br><br>Deriving first address...';

    // Derive first child (m/0/0)
    const child = node.derive("m/0/0");

    const { address } = bitcoin.payments.p2wpkh({
      pubkey: child.publicKey,
      network: network,
    });

    document.getElementById('result').innerHTML +=
      '<br><br>First address:<br>' + address + '<br><br>üéâ Everything works!';

    updateStatus(5, '‚úì XPUB parsed and address derived', 'success');

  } catch (e) {
    updateStatus(5, '‚úó XPUB parsing error: ' + e.message, 'error');
    document.getElementById('result').innerHTML = '‚ùå Error: ' + e.message;
  }
}
</script>

</body>
</html>





